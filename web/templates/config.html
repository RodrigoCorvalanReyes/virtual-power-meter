{% extends "base.html" %}

{% block title %}Configuración - Virtual Power Meter{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-cog text-primary"></i>
            Configuración del Simulador
        </h1>
    </div>
</div>

{% if request.query_params.get('success') %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle me-2"></i>
    Configuración actualizada correctamente.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div class="row">
    <div class="col-md-8">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-sliders-h"></i>
                    Parámetros del Simulador
                </h5>
                
                <form method="post" action="/api/config">
                    <!-- Protocolo -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="protocol" class="form-label">
                                <i class="fas fa-network-wired"></i>
                                Protocolo Modbus
                            </label>
                            <select class="form-select" id="protocol" name="protocol" onchange="toggleProtocolOptions()">
                                <option value="tcp" {% if config.protocol == 'tcp' %}selected{% endif %}>TCP</option>
                                <option value="rtu" {% if config.protocol == 'rtu' %}selected{% endif %}>RTU</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="devices" class="form-label">
                                <i class="fas fa-microchip"></i>
                                Número de Dispositivos
                            </label>
                            <select class="form-select" id="devices" name="devices">
                                <option value="1" {% if config.devices == 1 %}selected{% endif %}>1 Dispositivo</option>
                                <option value="2" {% if config.devices == 2 %}selected{% endif %}>2 Dispositivos</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- TCP Options -->
                    <div id="tcp-options" class="{% if config.protocol != 'tcp' %}d-none{% endif %}">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-ethernet"></i>
                            Configuración TCP
                        </h6>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="host" class="form-label">Host/IP</label>
                                <input type="text" class="form-control" id="host" name="host" value="{{ config.host }}">
                                <div class="form-text">0.0.0.0 para todas las interfaces</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="port" class="form-label">Puerto TCP</label>
                                <input type="number" class="form-control" id="port" name="port" value="{{ config.port }}" min="1" max="65535">
                                <div class="form-text">Puerto estándar Modbus: 502</div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="unit_id" class="form-label">Unit ID</label>
                                <input type="number" class="form-control" id="unit_id" name="unit_id" value="{{ config.unit_id }}" min="1" max="255">
                                <div class="form-text">ID del primer dispositivo</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RTU Options -->
                    <div id="rtu-options" class="{% if config.protocol != 'rtu' %}d-none{% endif %}">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-usb"></i>
                            Configuración RTU
                        </h6>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="port_serial" class="form-label">Puerto Serial</label>
                                <input type="text" class="form-control" id="port_serial" name="port_serial" value="{{ config.port_serial }}">
                                <div class="form-text">Ej: COM3 (Windows), /dev/ttyUSB0 (Linux)</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="baudrate" class="form-label">Baudrate</label>
                                <select class="form-select" id="baudrate" name="baudrate">
                                    <option value="9600" {% if config.baudrate == 9600 %}selected{% endif %}>9600</option>
                                    <option value="19200" {% if config.baudrate == 19200 %}selected{% endif %}>19200</option>
                                    <option value="38400" {% if config.baudrate == 38400 %}selected{% endif %}>38400</option>
                                    <option value="57600" {% if config.baudrate == 57600 %}selected{% endif %}>57600</option>
                                    <option value="115200" {% if config.baudrate == 115200 %}selected{% endif %}>115200</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="slave_id" class="form-label">Slave ID</label>
                                <input type="number" class="form-control" id="slave_id" name="slave_id" value="{{ config.slave_id }}" min="1" max="255">
                                <div class="form-text">ID del primer dispositivo</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- General Options -->
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-cogs"></i>
                        Configuración General
                    </h6>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="update_interval" class="form-label">
                                <i class="fas fa-clock"></i>
                                Intervalo de Actualización (segundos)
                            </label>
                            <input type="number" class="form-control" id="update_interval" name="update_interval" value="{{ config.update_interval }}" min="1" max="3600">
                            <div class="form-text">Frecuencia de actualización de valores</div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="verbose" name="verbose" value="true" {% if config.verbose %}checked{% endif %}>
                                <label class="form-check-label" for="verbose">
                                    <i class="fas fa-info-circle"></i>
                                    Modo Verbose
                                </label>
                                <div class="form-text">Mostrar información detallada en la consola</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            Guardar Configuración
                        </button>
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>
                            Volver al Dashboard
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Current Status -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-info-circle text-info"></i>
                    Estado Actual
                </h6>
                <div id="status-display">
                    <div class="d-flex align-items-center mb-2">
                        <div id="status-icon" class="me-2">
                            <i class="fas fa-circle text-secondary"></i>
                        </div>
                        <span id="status-text">Verificando...</span>
                    </div>
                </div>
                <small class="text-muted">
                    <i class="fas fa-exclamation-triangle"></i>
                    No se puede cambiar la configuración mientras el simulador está ejecutándose.
                </small>
            </div>
        </div>
        
        <!-- Help Card -->
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h6 class="card-title text-primary">
                    <i class="fas fa-question-circle"></i>
                    Ayuda
                </h6>
                
                <div class="accordion accordion-flush" id="helpAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="tcpHelp">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tcpHelpCollapse">
                                Configuración TCP
                            </button>
                        </h2>
                        <div id="tcpHelpCollapse" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled small">
                                    <li><strong>Host:</strong> IP donde se ejecutará el servidor</li>
                                    <li><strong>Puerto:</strong> Puerto TCP (estándar: 502)</li>
                                    <li><strong>Unit ID:</strong> Identificador del dispositivo</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="rtuHelp">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#rtuHelpCollapse">
                                Configuración RTU
                            </button>
                        </h2>
                        <div id="rtuHelpCollapse" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled small">
                                    <li><strong>Puerto Serial:</strong> Puerto de comunicación serie</li>
                                    <li><strong>Baudrate:</strong> Velocidad de comunicación</li>
                                    <li><strong>Slave ID:</strong> ID del dispositivo esclavo</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="generalHelp">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#generalHelpCollapse">
                                Configuración General
                            </button>
                        </h2>
                        <div id="generalHelpCollapse" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                            <div class="accordion-body">
                                <ul class="list-unstyled small">
                                    <li><strong>Dispositivos:</strong> Cantidad de medidores a simular</li>
                                    <li><strong>Intervalo:</strong> Frecuencia de actualización</li>
                                    <li><strong>Verbose:</strong> Información detallada en consola</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function toggleProtocolOptions() {
    const protocol = document.getElementById('protocol').value;
    const tcpOptions = document.getElementById('tcp-options');
    const rtuOptions = document.getElementById('rtu-options');
    
    if (protocol === 'tcp') {
        tcpOptions.classList.remove('d-none');
        rtuOptions.classList.add('d-none');
    } else {
        tcpOptions.classList.add('d-none');
        rtuOptions.classList.remove('d-none');
    }
}

function updateStatusDisplay() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            const statusIcon = document.getElementById('status-icon');
            const statusText = document.getElementById('status-text');
            const form = document.querySelector('form');
            
            if (data.is_running) {
                statusIcon.innerHTML = '<i class="fas fa-circle text-success"></i>';
                statusText.textContent = 'Simulador ejecutándose';
                
                // Deshabilitar formulario
                const inputs = form.querySelectorAll('input, select, button[type="submit"]');
                inputs.forEach(input => input.disabled = true);
            } else {
                statusIcon.innerHTML = '<i class="fas fa-circle text-secondary"></i>';
                statusText.textContent = 'Simulador detenido';
                
                // Habilitar formulario
                const inputs = form.querySelectorAll('input, select, button[type="submit"]');
                inputs.forEach(input => input.disabled = false);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('status-text').textContent = 'Error de conexión';
        });
}

// Actualizar estado al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    updateStatusDisplay();
    setInterval(updateStatusDisplay, 5000);
});
</script>
{% endblock %}